{{ $_hugo_config := `{ "version": 1 }` }}
{{$param := int (.Get "form_entry")}}
{{ with index .Page.Params.dynamic_form_engine $param }}
<div class="container-fluid mt-5 p-0 score-card--container" id="{{.id}}">
  <div class="shadow form-mobile-desktop-layout bg-white rounded-blue-border">

    <!-- Title and icon -->
    <h3 class="">
      <span class="{{.icon}} icon mb-4 pl-5 remove-on-pdf"></span>
      {{.title}}
    </h3>

    <div class="row mt-4">
      <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <p>{{ .content | markdownify }}</p>
      </div>
    </div>

    {{ range .section }}
    <div class="mb-4">
      <h4>{{.title}}</h4>
    </div>

    {{ range .questions }}



    {{ $visibilityCondition := "" }}
    {{ range .visible_when_or }}
    {{ range .visible_when_and }}
    {{ $visibilityCondition = printf "%s" $visibilityCondition | printf "%s%s" .value | printf "%s" }}
    {{ $visibilityCondition = printf "%s" $visibilityCondition | printf "%s%s" "=" | printf "%s" }}
    {{ $visibilityCondition = printf "%s" $visibilityCondition | printf "%s%s" .identifier | printf "%s" }}
    {{ $visibilityCondition = printf "%s" $visibilityCondition | printf "%s%s" "&&" | printf "%s" }}
    {{ end }}
    {{ $visibilityCondition = printf "%s" $visibilityCondition | printf "%s%s" "||" | printf "%s" }}
    {{ end }}
    <div class="score-card__question" {{if $visibilityCondition}}data-show-when="{{$visibilityCondition}}" {{end}}>
      <h5>
        {{ .title }}
        {{ if .tooltip }}
        <button class="remove-on-pdf information-button mt-0" data-toggle="tooltip" data-placement="right"
          title={{.tooltip}}>
          i
        </button>
        {{ end }}
      </h5>

      <p>
        {{ .content | markdownify }}
      </p>

      <div class="row mb-4">
        {{ $input_name := .identifier }}
        {{ range .options }}
        <div class="col-md col-sm-12">
          <label>
            <input type="radio" name={{$input_name}} class="card-input-element" value={{.value}} />
            <div class="card card-input">
              <div class="card-body {{ if not .content }}d-flex justify-content-center{{end}}">
                <h4 class="card-title">{{.title}}</h4>
                <p class="card-text">
                  {{.content | markdownify}}
                </p>
              </div>
            </div>
          </label>
        </div>
        {{ end }}

      </div>
    </div>
    {{ end}}
    {{ end }}
    

    <div class="row mt-5">
      <div class="col-xl col-sm-12">
        <button id="score-card-print-button" class="btn btn-primary remove-on-pdf"><i class="fas fa-print"></i> {{i18n
          "score-card--download-result"}}</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function (event) {

    var calculateVisibleFields = function () {
      // this is what the data attribute looks like: data-show-when="||&&data1=medium&&data2=medium||&&data1=low"
      // This field should be hidden when no input is selected, and shown if either data 1 and data 2 are medium or data 1 is low.
      $('.score-card__question').each(function () {
        const showWhen = $(this).attr('data-show-when');
        // check if the attribute is there, otherwise always keep it as is.
        if (showWhen) {
          const orConditions = showWhen.split('||');
          let show = false;
          orConditions.forEach((orCondition) => {
            // The first element is always an empty string.
            const andConditions = orCondition.split('&&').slice(1);
            let andShow = andConditions.length > 0;
            andConditions.forEach((andCondition) => {
              if (andCondition.indexOf('=') === -1) {
                return;
              }
              const [data, value] = andCondition.split('=');
              const input = document.querySelector(`.score-card__question:not(.d-none) input[name=${data}]:checked`);
              if (!input || input.value !== value) {
                andShow = false;
              }
            });
            if (andShow) {
              show = true;
            }
          });
          if (show) {
            $(this).removeClass("d-none");
          } else {
            $(this).addClass("d-none");
          }
        }
      })
    };
    $('#{{.id}} input').change(calculateVisibleFields);
    calculateVisibleFields();


    $('#score-card-print-button').click(function () {
      window.html2canvas = html2canvas;
      var element = document.getElementById("{{.id}}");
      var pdf = new jspdf.jsPDF();
      pdf.html(element, {
        callback: function (doc) {
          doc.save();
        },
        margin: [5, 5, 5, 5],
        x: 32,
        y: 32,
        html2canvas: {
          scale: 0.15,
          ignoreElements: (element) => {
            if (element.className.indexOf('remove-on-pdf') > -1) {
              return true;
            }
            return false;
          }
        },

      });
    });
  });
</script>

{{ end }}