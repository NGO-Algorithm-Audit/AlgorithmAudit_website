{{ $_hugo_config := `{ "version": 1 }` }}
{{ with .Page.Params.card_risk_classification }}

<div class="container-fluid mt-5 p-0 score-card--container" id="risk-classification">
  <div class="shadow form-mobile-desktop-layout bg-white rounded-blue-border">

    <!-- Title and icon -->
    <h3 class="">
      <span class="far fa-flag icon mb-4 pl-5 remove-on-pdf"></span>
      {{.title}}
    </h3>

    <div class="row mt-4">
      <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <p>{{ .content | markdownify }}</p>
      </div>
    </div>

    {{ range .section }}
    <div class="mb-4">
      <h4>{{.title}}</h4>
    </div>

    {{ range .questions }}



    {{ $visibilityCondition := "" }}
    {{ range .visible_when_or }}
    {{ range .visible_when_and }}
    {{ $visibilityCondition = printf "%s" $visibilityCondition | printf "%s%s" .value | printf "%s" }}
    {{ $visibilityCondition = printf "%s" $visibilityCondition | printf "%s%s" "=" | printf "%s" }}
    {{ $visibilityCondition = printf "%s" $visibilityCondition | printf "%s%s" .identifier | printf "%s" }}
    {{ $visibilityCondition = printf "%s" $visibilityCondition | printf "%s%s" "&&" | printf "%s" }}
    {{ end }}
    {{ $visibilityCondition = printf "%s" $visibilityCondition | printf "%s%s" "||" | printf "%s" }}
    {{ end }}
    <div class="score-card__question" {{if $visibilityCondition}}data-show-when="{{$visibilityCondition}}" {{end}}>
      <h5>
        {{ .title }}
        {{ if .tooltip }}
        <button class="remove-on-pdf information-button mt-0" data-toggle="tooltip" data-placement="right"
          title={{.tooltip}}>
          i
        </button>
        {{ end }}
      </h5>

      <p>
        {{ .content | markdownify }}
      </p>

      <div class="row mb-4">
        {{ $input_name := .identifier }}
        {{ range .options }}
        <div class="col-md col-sm-12">
          <label>
            <input type="radio" name={{$input_name}} class="card-input-element" value={{.value}} />
            <div class="card card-input {{ if not .content }}d-flex justify-content-center{{end}}">
              <div class="card-body">
                <h4 class="card-title">{{.title}}</h4>
                <p class="card-text">
                  {{.content | markdownify}}
                </p>
              </div>
            </div>
          </label>
        </div>
        {{ end }}

      </div>
    </div>
    {{ end}}
    {{ end }}
    <div class="shadow bg-lightblue py-4">
      <div class="row mx-3">
        <div class="col">
          <h4>
            {{ i18n "score-card--adjust" }}</h4>
        </div>
      </div>
      <div class="row mx-3 mt-4 mb-2">
        <div class="col-xl col-sm-12">
          <p>
            {{ i18n "score-card--scoring" }}
          </p>
        </div>

        <div class="col-xl col-sm-12">
          <div class="row align-items-start">
            <div class="col-xl-4 col-sm-6">
              <p class="text-nowrap">
                {{i18n "score-card--low"}}
              </p>
            </div>
            <div class="col-xl-7 col-sm-6">
              <input id="score-card-points-low" type="number" class="form-control" value="0" disabled>
            </div>
          </div>
        </div>

        <div class="col-xl col-sm-12">
          <div class="row align-items-start">
            <div class="col-xl-4 col-sm-6">
              <p class="text-nowrap">
                {{i18n "score-card--medium"}}
              </p>
            </div>
            <div class="col-xl-7 col-sm-6">
              <input id="score-card-points-medium" type="number" class="form-control" value="5">
            </div>
          </div>
        </div>

        <div class="col-xl col-sm-12">
          <div class="row align-items-start">
            <div class="col-xl-4 col-sm-6">
              <p class="text-nowrap">
                {{i18n "score-card--high"}}
              </p>
            </div>
            <div class="col-xl-7 col-sm-6">
              <input id="score-card-points-high" type="number" class="form-control" value="10">
            </div>
          </div>
        </div>
      </div>

      <div class="row mx-3 mt-4 mb-2">
        <div class="col-xl col-sm-12">
          <p>
            {{i18n "score-card--boundary-conditions"}}
          </p>
        </div>

        <div class="col-xl col-sm-12">
          <div class="row align-items-start">
            <div class="col-xl-4 col-sm-6">
              <p class="text-nowrap">
                {{i18n "score-card--low"}}
              </p>
            </div>
            <div class="col-xl-7 col-sm-6">
              <input id="score-card-threshold-low" type="number" class="form-control" value="0" disabled>
            </div>
          </div>
        </div>

        <div class="col-xl col-sm-12">
          <div class="row align-items-start">
            <div class="col-xl-4 col-sm-6">
              <p class="text-nowrap">
                {{i18n "score-card--medium"}}
              </p>
            </div>
            <div class="col-xl-7 col-sm-6">
              <input id="score-card-threshold-medium" type="number" class="form-control" value="5">
            </div>
          </div>
        </div>

        <div class="col-xl col-sm-12">
          <div class="row align-items-start">
            <div class="col-xl-4 col-sm-6">
              <p class="text-nowrap">
                {{i18n "score-card--high"}}
              </p>
            </div>
            <div class="col-xl-7 col-sm-6">
              <input id="score-card-threshold-high" type="number" class="form-control" value="10">
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row mt-5">
      <div class="col-xl col-sm-12">
        <p>
        <div class="d-inline-block color-blue font-weight-bold">{{i18n "score-card--total-score"}}: </div>
        <div id="score-card-result-score" class="d-inline-block color-gray"></div>
        </p>
        <p>
        <div class="d-inline-block color-blue font-weight-bold">{{i18n "score-card--classification"}}: </div>
        <div id="score-card-result-risk" class="d-inline-block color-gray"></div>
        </p>
      </div>
      <div class="col-xl col-sm-12">
        <button id="score-card-print-button" class="btn btn-primary remove-on-pdf"><i class="fas fa-print"></i> {{i18n
          "score-card--download-result"}}</button>
      </div>
    </div>
  </div>
</div>

{{ end }}

<script>
  document.addEventListener("DOMContentLoaded", function (event) {

    var calculateVisibleFields = function () {
      // this is what the data attribute looks like: data-show-when="||&&data1=medium&&data2=medium||&&data1=low"
      // This field should be hidden when no input is selected, and shown if either data 1 and data 2 are medium or data 1 is low.
      $('.score-card__question').each(function () {
        const showWhen = $(this).attr('data-show-when');
        // check if the attribute is there, otherwise always keep it as is.
        if (showWhen) {
          const orConditions = showWhen.split('||');
          let show = false;
          orConditions.forEach((orCondition) => {
            // The first element is always an empty string.
            const andConditions = orCondition.split('&&').slice(1);
            let andShow = andConditions.length > 0;
            andConditions.forEach((andCondition) => {
              if (andCondition.indexOf('=') === -1) {
                return;
              }
              const [data, value] = andCondition.split('=');
              const input = document.querySelector(`.score-card__question:not(.d-none) input[name=${data}]:checked`);
              if (!input || input.value !== value) {
                andShow = false;
              }
            });
            if (andShow) {
              show = true;
            }
          });
          if (show) {
            $(this).removeClass("d-none");
          } else {
            $(this).addClass("d-none");
          }
        }
      })
    };
    var calculateScores = function () {
      var score = 0;
      var points = {
        low: parseInt($('#score-card-points-low').val()),
        medium: parseInt($('#score-card-points-medium').val()),
        high: parseInt($('#score-card-points-high').val())
      };
      var thresholds = {
        low: parseInt($('#score-card-threshold-low').val()),
        medium: parseInt($('#score-card-threshold-medium').val()),
        high: parseInt($('#score-card-threshold-high').val())
      };
      $('.score-card__question:not(.d-none) input[type=radio]:checked').each(function () {
        score += points[$(this).val()];
      });
      $('#score-card-result-score').text(score);
      $('#score-card-result-risk').text(score >= thresholds.high ? '{{i18n "score-card--high-risk"}}' : score >= thresholds.medium ? '{{i18n "score-card--medium-risk"}}' : '{{i18n "score-card--low-risk"}}');
    };
    $('#score-card-container input[type=radio]').change(() => {
      calculateVisibleFields();
      calculateScores();
    });
    $('#score-card-container input[type=number]').change(calculateScores);
    calculateVisibleFields();
    calculateScores();


    $('#score-card-print-button').click(function () {
      window.html2canvas = html2canvas;
      var element = document.getElementById("score-card-container");
      var pdf = new jspdf.jsPDF();
      pdf.html(element, {
        callback: function (doc) {
          doc.save();
        },
        margin: [5, 5, 5, 5],
        x: 32,
        y: 32,
        html2canvas: {
          scale: 0.15,
          ignoreElements: (element) => {
            if (element.className.indexOf('remove-on-pdf') > -1) {
              return true;
            }
            return false;
          }
        },

      });
    });
  });
</script>